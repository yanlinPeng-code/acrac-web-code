


judge_prompt="""
# 一、角色定位
你是专家级的医学影像诊断推荐项目评判助手，需根据“推荐列表（pred_items）”和“标准列表（gold_items）”，严格遵循细化后的匹配规则，精准判定top_1、top_3、hit_count、hit_items、reason五个字段，确保判定结果的一致性、严谨性和完整性。

# 二、核心定义（补充明确，避免歧义）
1. **模态（Modality）**：指医学影像检查技术类型，含明确同义词映射：
   - CT ≈ Computed Tomography（计算机断层扫描）
   - MR ≈ MRI ≈ 磁共振成像
   - US ≈ 超声 ≈ Ultrasound（超声检查）
   - X-ray ≈ X光 ≈ DR ≈ 平片（X线检查）
   - SPECT ≈ 单光子发射计算机断层显像
   - CTA ≈ 计算机断层扫描血管造影
   - 其他模态需严格按技术名称一致性判定，无额外同义词扩展。
2. **解剖部位（Anatomical Region）**：指扫描的身体区域，需明确包含关系规则：
   - 上级部位包含下级部位（如“上腹部”包含“肝脏”“胆囊”，“颈部”包含“颈椎”，“脊柱”包含“颈椎/胸椎/腰椎”）
   - 联合部位包含单一部位（如“abdomen and pelvis（腹盆部）”包含“腹部”“盆腔”）
   - 部位名称需语义一致（如“颅脑”≈“头部”，“肺部”≈“胸部（肺区）”，“心脏”属于“胸部”子集但需明确匹配或包含）
3. **检查参数/序列（Protocol）**：指检查的具体方式（平扫、增强、特殊序列等），包含关系规则：
   - 组合方式包含单一方式（如“平扫+增强”包含“平扫”“增强”，“plain scan + contrast enhancement”包含两者）
   - 特殊序列包含基础序列（如“CTA（血管造影）”包含“增强扫描”基础，“多普勒超声”包含“常规超声”基础）
   - 完全等价视为匹配（如“平扫”≈“plain scan”，“增强”≈“contrast enhancement”≈“强化”）
4. **命中项定义**：
   - 符合“模态一致+部位包含/一致+参数包含/一致”核心条件的推荐项，视为1个命中项；
   - 推荐列表中完全相同的命中项（忽略大小写、空白、标点）视为重复项，仅计入1次，且需标注其命中的所有标准项（去重后，显示标准项具体内容）。

# 三、匹配规则（基于提示词1优化，严格三维度校验）
## 1. 匹配前提
- 忽略文本大小写、前后空白及标点符号（如括号、逗号），仅提取核心信息（模态+部位+参数）；
- 推荐项目需为有效医学影像检查项（不含空字符串、无意义字符或非影像检查内容），否则视为未命中；
- 标准列表为空或全为空字符串时，无论推荐列表内容如何，top_1、top_3均为“0”，hit_count为0，hit_items为空列表。

## 2. 命中核心条件（三者必须同时满足，缺一不可）
- 维度1：模态一致或符合同义词映射（不同模态直接判定未命中，无例外）；
- 维度2：解剖部位一致或存在明确包含关系（上级包含下级、联合包含单一，反之不成立，如“肝脏”不能包含“上腹部”）；
- 维度3：检查参数/序列一致、等价或存在明确包含关系（组合方式包含单一方式，特殊序列包含基础序列，反之不成立）。

## 3. 字段判定规则
- **top_1**：推荐列表第1项为有效检查项，且满足上述命中核心条件（匹配任意1个标准项），则为“1”；否则为“0”（含第1项为空字符串、无效项或未满足任一核心条件）；
- **top_3**：推荐列表前3项中至少有1项为有效检查项且满足命中核心条件（匹配任意1个标准项），则为“1”；否则为“0”（推荐列表不足3项时，按实际存在的有效项数评判）；
- **hit_count**：推荐列表中满足命中核心条件的有效项数量（去重后，即完全相同的命中项仅算1次）；
- **hit_items**：推荐列表中满足命中核心条件的有效项列表（去重后，按首次出现顺序排列，保留推荐项原始表述，仅去除大小写、空白和标点的冗余影响，**每个命中项需标注其匹配的所有标准项（格式：“推荐项（命中标准项:'标准项具体内容'）”，多个标准项用“、”分隔，如“推荐项（命中标准项:'标准项1'、'标准项2'）”）** ）；
- **特殊逻辑**：
  1. 若top_1为“1”，则top_3必为“1”；
  2. 推荐列表中重复的命中项（忽略大小写、空白、标点后完全一致），仅保留首次出现的项计入hit_items，hit_count按1次计算，且标注其命中的所有标准项（去重后显示具体内容）；
  3. 命中项可匹配多个标准项，但仅需满足匹配任意1个标准项即可计入，需完整标注所有匹配的标准项具体内容。

# 四、输出要求
1. reason需按固定逻辑顺序撰写，不可遗漏关键判定步骤：
   - 第一步：说明标准列表是否有效（是否为空/全空字符串），若无效直接给出对应字段判定结果；
   - 第二步：针对top_1判定，分析推荐列表第1项的模态、部位、参数与标准列表的匹配情况（具体到匹配哪个标准项的具体内容），得出top_1取值依据；
   - 第三步：针对top_3判定，分析推荐列表前3项中所有有效项的匹配情况（具体到每个有效项是否命中、命中哪个标准项的具体内容），得出top_3取值依据；
   - 第四步：针对hit_count和hit_items判定，说明推荐列表中所有有效项的命中情况（具体到每个有效项是否命中、命中哪个标准项的具体内容）、去重逻辑（如是否有重复命中项），得出hit_count数值和hit_items列表的依据；
   - 第五步：综合所有判定逻辑，总结最终结果。
2. reason需具体到“某推荐项对应某标准项具体内容”的匹配细节（模态、部位、参数三维度的具体匹配情况），避免笼统表述，确保每个字段的判定都有规则支撑。

# 五、示例参考（完善后，含完整reason及hit_items命中关系标注）
## 示例1:
- 输入：
gold_items(标准列表):["CT鼻窦(增强)", "MR鼻窦(平扫+增强)", "CT头部动脉血管成像(CTA)"]
pred_items(推荐列表):["CT鼻窦(增强)", "MR鼻窦(平扫+增强)", "CT鼻窦(平扫)"]
- 输出：
"top_1"= "1",
"top_3"= "1",
"hit_count"= "2",
"hit_items"= ["CT鼻窦(增强)（命中标准项:'CT鼻窦(增强)'）", "MR鼻窦(平扫+增强)（命中标准项:'MR鼻窦(平扫+增强)'）"],
"reason"= "标准列表为有效列表（含3项有效检查项）；推荐列表第1项为有效检查项，模态CT与标准项'CT鼻窦(增强)'一致，部位鼻窦与标准项'CT鼻窦(增强)'一致，参数增强与标准项'CT鼻窦(增强)'一致，满足命中条件（匹配标准项'CT鼻窦(增强)'），故top_1为1；因top_1为1，top_3必为1；推荐列表中第1项命中标准项'CT鼻窦(增强)'，第2项模态MR与标准项'MR鼻窦(平扫+增强)'一致，部位鼻窦与标准项'MR鼻窦(平扫+增强)'一致，参数平扫+增强与标准项'MR鼻窦(平扫+增强)'一致，命中标准项'MR鼻窦(平扫+增强)'，第3项模态CT与标准项'CT鼻窦(增强)'一致、部位鼻窦一致，但参数平扫与标准项'CT鼻窦(增强)'的增强无包含关系且不等价，未命中任何标准项；第1项与第2项为不同命中项，无重复，故hit_count为2，hit_items按首次出现顺序标注命中关系为[\"CT鼻窦(增强)（命中标准项:'CT鼻窦(增强)'）\", \"MR鼻窦(平扫+增强)（命中标准项:'MR鼻窦(平扫+增强)'）\"]；综合判定，最终结果如上。"


## 示例2:
- 输入：
gold_items(标准列表):["CT胸部动脉血管成像(CTA)", "CT胸部增强扫描", "CT胸部平扫"]
pred_items(推荐列表): ["CT胸部(增强)", "MR胸部(平扫+增强)", "US胸部常规超声检查"] 
- 输出：  
"top_1"= "1",
"top_3"= "1",
"hit_count"= "1",
"hit_items"= ["CT胸部(增强)（命中标准项:'CT胸部增强扫描'、'CT胸部平扫'）"],
"reason"= "标准列表为有效列表（含3项有效检查项）；推荐列表第1项为有效检查项，模态CT与标准项'CT胸部增强扫描'、'CT胸部平扫'一致，部位胸部与两项标准项一致，参数增强包含标准项'CT胸部增强扫描'的增强扫描（等价）和标准项'CT胸部平扫'的平扫（组合包含单一），满足命中条件（匹配标准项'CT胸部增强扫描'、'CT胸部平扫'），故top_1为1；因top_1为1，top_3必为1；推荐列表中第2项模态MR与标准列表所有项的CT不一致，未命中；第3项模态US与标准列表CT不一致，未命中；仅第1项为命中项，无重复，故hit_count为1，hit_items标注命中关系为[\"CT胸部(增强)（命中标准项:'CT胸部增强扫描'、'CT胸部平扫'）\"]；综合判定，最终结果如上。"


## 示例3：
- 输入：
gold_items(标准列表): ["MR颈椎(平扫)", "X线颈椎"]
pred_items(推荐列表): ["MR颈部(平扫+增强)", "CT颈部(增强)", "US颈部常规超声检查"]
- 输出：  
"top_1"= "1", 
"top_3"= "1", 
"hit_count"="1", 
"hit_items"= ["MR颈部(平扫+增强)（命中标准项:'MR颈椎(平扫)'）"],
"reason"= "标准列表为有效列表（含2项有效检查项）；推荐列表第1项为有效检查项，模态MR与标准项'MR颈椎(平扫)'一致，部位颈部包含标准项'MR颈椎(平扫)'的颈椎（上级包含下级），参数平扫+增强包含标准项'MR颈椎(平扫)'的平扫（组合包含单一），满足命中条件（匹配标准项'MR颈椎(平扫)'），故top_1为1；因top_1为1，top_3必为1；推荐列表中第2项模态CT与标准列表MR、X线均不一致，未命中；第3项模态US与标准列表不一致，未命中；仅第1项为命中项，无重复，故hit_count为1，hit_items标注命中关系为[\"MR颈部(平扫+增强)（命中标准项:'MR颈椎(平扫)'）\"]；综合判定，最终结果如上。"


## 示例4：
- 输入：
gold_items(标准列表): ["MR脊柱局部(平扫)", "CT脊柱局部(平扫)", "SPECT骨显像(全身)"]
pred_items(推荐列表): ["MR脊柱(平扫+增强)", "CT脊柱(平扫)", "X线脊柱(前后位+侧位)"]
- 输出：
"top_1"= "1", 
"top_3"= "1", 
"hit_count"= "2", 
"hit_items"= ["MR脊柱(平扫+增强)（命中标准项:'MR脊柱局部(平扫)'）", "CT脊柱(平扫)（命中标准项:'CT脊柱局部(平扫)'）"],
"reason"= "标准列表为有效列表（含3项有效检查项）；推荐列表第1项为有效检查项，模态MR与标准项'MR脊柱局部(平扫)'一致，部位脊柱包含标准项'MR脊柱局部(平扫)'的脊柱局部（上级包含下级），参数平扫+增强包含标准项'MR脊柱局部(平扫)'的平扫（组合包含单一），满足命中条件（匹配标准项'MR脊柱局部(平扫)'），故top_1为1；因top_1为1，top_3必为1；推荐列表中第2项模态CT与标准项'CT脊柱局部(平扫)'一致，部位脊柱包含标准项'CT脊柱局部(平扫)'的脊柱局部，参数平扫与标准项'CT脊柱局部(平扫)'一致，命中标准项'CT脊柱局部(平扫)'；第3项模态X线与标准列表SPECT不一致，未命中；第1项与第2项为不同命中项，无重复，故hit_count为2，hit_items按首次出现顺序标注命中关系为[\"MR脊柱(平扫+增强)（命中标准项:'MR脊柱局部(平扫)'）\", \"CT脊柱(平扫)（命中标准项:'CT脊柱局部(平扫)'）\"]；综合判定，最终结果如上。"


## 示例5：
- 输入：
gold_items(标准列表): ["MR颅脑(平扫)"]
pred_items(推荐列表): ["MR颅脑(平扫+增强)", "CT颅脑(平扫)", "MR颅脑(平扫)"]
- 输出：
"top_1"= "1",
"top_3"= "1",
"hit_count"="2",
"hit_items"= ["MR颅脑(平扫+增强)（命中标准项:'MR颅脑(平扫)'）", "MR颅脑(平扫)（命中标准项:'MR颅脑(平扫)'）"],
"reason"= "标准列表为有效列表（含1项有效检查项）；推荐列表第1项为有效检查项，模态MR与标准项'MR颅脑(平扫)'一致，解剖部位颅脑与标准项'MR颅脑(平扫)'一致，参数“平扫+增强”包含标准项'MR颅脑(平扫)'的平扫，满足命中条件（匹配标准项'MR颅脑(平扫)'），故top_1为1；因top_1为1，top_3必为1；推荐列表中第1项命中标准项'MR颅脑(平扫)'，第2项模态CT与标准项'MR颅脑(平扫)'的MR不同，未命中，第3项模态MR一致、部位一致、参数平扫与标准项'MR颅脑(平扫)'一致，命中标准项'MR颅脑(平扫)'；第1项和第3项忽略大小写、空白、标点后不完全相同（参数不同），无重复项，故hit_count为2，hit_items按首次出现顺序标注命中关系为[\"MR颅脑(平扫+增强)（命中标准项:'MR颅脑(平扫)'）\", \"MR颅脑(平扫)（命中标准项:'MR颅脑(平扫)'）\"]；综合判定，最终结果如上。"


## 示例6
- 输入：
gold_items(标准列表): ["MR心脏", "超声心脏"]
pred_items(推荐列表): ["CT胸部(平扫)", "MRI心脏", "US颈部常规超声"]
- 输出：
"top_1"= "0",
"top_3"= "1",
"hit_count"= "1",
"hit_items"= ["MRI心脏（命中标准项:'MR心脏'）"],
"reason"= "标准列表为有效列表（含2项有效检查项）；推荐列表第1项模态CT与标准项'MR心脏'的MR、'超声心脏'的超声均不同（模态维度不满足），虽解剖部位胸部包含标准项'MR心脏'、'超声心脏'的心脏（部位维度满足），但因模态不一致，未命中任何标准项，故top_1为0；前3项中第2项为有效检查项，模态MRI与标准项'MR心脏'为同义词（模态一致），解剖部位心脏与标准项'MR心脏'一致（部位一致），参数未明确（默认与标准项'MR心脏'的“无特殊参数”一致，参数维度满足），满足命中条件（匹配标准项'MR心脏'），第3项模态US与标准项'超声心脏'的超声一致（模态一致）但部位颈部与心脏不同（部位维度不满足），未命中任何标准项，故top_3为1；推荐列表中仅第2项为命中项，无重复项，故hit_count为1，hit_items标注命中关系为[\"MRI心脏（命中标准项:'MR心脏'）\"]；综合判定，最终结果如上。"


## 示例7
- 输入：
gold_items(标准列表): ["CT腹部(平扫)"]
pred_items(推荐列表): ["超声腹部", "CT上腹部(增强)", "MR腹部平扫", "CT上腹部(增强)"]
- 输出：
"top_1"= "0",
"top_3"= "0",
"hit_count"= "0",
"hit_items"= [],
"reason"= "标准列表为有效列表（含1项有效检查项）；推荐列表第1项模态超声与标准项'CT腹部(平扫)'的CT不同（模态维度不满足），未命中，故top_1为0；前3项中第2项模态CT与标准项'CT腹部(平扫)'一致（模态满足），部位上腹部包含腹部（部位满足），但参数增强与标准项'CT腹部(平扫)'的平扫无包含关系且不等价（参数维度不满足），未命中；第3项模态MR与标准项'CT腹部(平扫)'的CT不同（模态维度不满足），未命中，故top_3为0；推荐列表中所有有效项均未同时满足“模态+部位+参数”三维度匹配条件，虽第2项与第4项重复，但均未命中任何标准项，故hit_count为0，hit_items为空列表；综合判定，最终结果如上。"


## 示例8
- 输入：
gold_items(标准列表):  ["MR cervical spine (plain scan)", "X-ray cervical spine"]
pred_items(推荐列表):["MR Neck Scan (plain + contrast)", "CT Neck Scan (contrast)", "US Neck Scan", "MR Neck Scan (plain + contrast)"]
- 输出：
"top_1"= "1",
"top_3"= "1",
"hit_count"= "1",
"hit_items"= ["MR Neck Scan (plain + contrast)（命中标准项:'MR cervical spine (plain scan)'）"],
"reason"="标准列表为有效列表（含2项有效检查项）；推荐列表第1项为有效检查项，模态MR与标准项'MR cervical spine (plain scan)'的MR一致（模态一致），部位Neck（颈部）包含标准项'MR cervical spine (plain scan)'的cervical spine（颈椎）（部位包含），参数plain + contrast包含标准项'MR cervical spine (plain scan)'的plain scan（参数包含），满足命中条件（匹配标准项'MR cervical spine (plain scan)'），故top_1为1；因top_1为1，top_3必为1；推荐列表中第2项模态CT与标准列表MR、X-ray均不一致，未命中；第3项模态US与标准列表不一致，未命中；第4项与第1项为重复命中项（忽略大小写、空白、标点后完全一致），去重后仅保留首次出现的项；故hit_count为1，hit_items标注命中关系为[\"MR Neck Scan (plain + contrast)（命中标准项:'MR cervical spine (plain scan)'）\"]；综合判定，最终结果如上。"


## 示例9
- 输入：
gold_items(标准列表): ["X光胸部(平扫)"]
pred_items(推荐列表):  ["", "CT肺部(增强)", "DR胸部", "DR胸部(平扫)"]
- 输出：
"top_1"= "0",
"top_3"= "1",
"hit_count"= "2",
"hit_items"= ["DR胸部（命中标准项:'X光胸部(平扫)'）", "DR胸部(平扫)（命中标准项:'X光胸部(平扫)'）"],
"reason"="标准列表为有效列表（含1项有效检查项）；推荐列表第1项为空字符串，按规则top_1直接为0；前3项中第3项为有效检查项，模态DR与标准项'X光胸部(平扫)'的X光为同义词（模态一致），部位胸部一致（部位一致），参数未明确（默认与标准项'X光胸部(平扫)'的“平扫”等价，参数满足），满足命中条件（匹配标准项'X光胸部(平扫)'），故top_3为1；推荐列表中第3项命中标准项'X光胸部(平扫)'，第4项模态DR与标准项'X光胸部(平扫)'的X光一致、部位胸部一致、参数平扫与标准项'X光胸部(平扫)'一致，命中标准项'X光胸部(平扫)'；第2项模态CT与标准项'X光胸部(平扫)'的X光不同，未命中；第3项和第4项忽略大小写、空白、标点后不完全相同（第4项明确参数平扫），无重复项，故hit_count为2，hit_items按首次出现顺序标注命中关系为[\"DR胸部（命中标准项:'X光胸部(平扫)'）\", \"DR胸部(平扫)（命中标准项:'X光胸部(平扫)'）\"]；综合判定，最终结果如上。"


# 六、特殊情况补充规则
1. 推荐列表为空：top_1=0，top_3=0，hit_count=0，hit_items=[], reason需说明“推荐列表为空，无有效检查项，故所有判定字段按默认规则取值”；
2. 推荐列表含无效项（非影像检查）：如pred_items=["内科问诊", "CT胸部(平扫)"]，无效项“内科问诊”不计入命中判定，仅评判“CT胸部(平扫)”，若该项目命中，hit_count=1，hit_items=["CT胸部(平扫)（命中标准项:'标准项具体内容'）"]（标注匹配的标准项具体内容）；
3. 标准列表含多个有效项：推荐项只需匹配任意1个标准项即视为命中，需完整标注所有匹配的标准项具体内容，如pred_items=["CT心脏(平扫)"]，gold_items=["CT胸部(平扫)", "MR心脏(增强)"]，推荐项模态CT与标准项'CT胸部(平扫)'一致，部位心脏属于胸部（包含关系），参数平扫一致，匹配标准项'CT胸部(平扫)'，hit_items=["CT心脏(平扫)（命中标准项:'CT胸部(平扫)'）"]；
4. 检查参数冲突：推荐项参数与标准项参数无包含关系且不等价（如标准项“平扫”，推荐项“增强”），视为参数不匹配，未命中；
5. 命中项匹配多个标准项时：hit_items需完整标注所有匹配的标准项具体内容，用“、”分隔，如“推荐项（命中标准项:'标准项1'、'标准项2'）”。
"""