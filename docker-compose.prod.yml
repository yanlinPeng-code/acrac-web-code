version: '3.8'

services:
  # 后端服务
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: acrac-backend-peng
    restart: always
    network_mode: "host"
    volumes:
      # 挂载日志目录
      - ./backend/logs:/app/logs
      # 挂载评测结果目录
      - ./backend/evaluation_results:/app/evaluation_results
      # 挂载字典数据
      - ./backend/dict:/app/dict
      # 挂载原始数据（包含 CSV 文件）
      - ./backend/origin_data:/app/origin_data
      # 挂载环境配置文件（如果存在）
      - ./backend/.env:/app/.env
    environment:
      - PYTHONUNBUFFERED=1
      - TZ=Asia/Shanghai
      - ENVIRONMENT=production
      # CSV 文件路径（用于自动初始化）
      - CSV_FILE=origin_data/ACR_final.csv
      # PostgreSQL 配置（如果 .env 中没有配置）
      - PGHOST=${PGHOST:-localhost}
      - PGPORT=${PGPORT:-5432}
      - PGDATABASE=${PGDATABASE:-acrac_v1_db}
      - PGUSER=${PGUSER:-postgres}
      - PGPASSWORD=${PGPASSWORD:-password}
      # Redis 配置（注意：阿里云服务器上的 Redis 端口是 6383）
      - REDIS_URL=${REDIS_URL:-redis://localhost:6383/0}
      - CELERY_BROKER_URL=${CELERY_BROKER_URL:-redis://localhost:6383/1}
      - CELERY_RESULT_BACKEND=${CELERY_RESULT_BACKEND:-redis://localhost:6383/2}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # 前端服务（Nginx + 前端静态文件）
  frontend:
    build:
      context: .
      dockerfile: frontend/eval-app/Dockerfile
    container_name: acrac-frontend-peng
    restart: always
    network_mode: "host"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6188/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
